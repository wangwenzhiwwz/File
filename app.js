const sites = [
    {
        "name": "大师兄影视",
        "url": "https://dsxys.com/?ref=dsxdh.com",
        "logo": "",
        "category": [
            "影视"
        ]
    },
    {
        "name": "iTalkBB TV",
        "url": "https://www.italkbbtv.com/",
        "logo": "",
        "category": [
            "TV"
        ]
    },
    {
        "name": "CNYS TV",
        "url": "https://cnys.tv/",
        "logo": "",
        "category": [
            "TV"
        ]
    },
    {
        "name": "欧乐影视",
        "url": "https://www.olevod.tv/",
        "logo": "",
        "category": [
            "影视"
        ]
    },
    {
        "name": "NoVIP 去广告",
        "url": "https://www.novipnoad.net/",
        "logo": "",
        "category": [
            "影视"
        ]
    },
    {
        "name": "乐影影视",
        "url": "https://www.lyys8.com/#2tun.com",
        "logo": "",
        "category": [
            "影视"
        ]
    },
    {
        "name": "低端影视",
        "url": "https://ddys.pro/",
        "logo": "",
        "category": [
            "影视"
        ]
    },
    {
        "name": "爱奇艺",
        "url": "https://www.iqiyi.com/",
        "logo": "",
        "category": [
            "影视"
        ]
    },
    {
        "name": "腾讯视频",
        "url": "https://v.qq.com/",
        "logo": "",
        "category": [
            "影视"
        ]
    },
    {
        "name": "优酷视频",
        "url": "https://www.youku.com/",
        "logo": "",
        "category": [
            "影视"
        ]
    },
    {
        "name": "哔哩哔哩",
        "url": "https://www.bilibili.com/",
        "logo": "",
        "category": [
            "影视"
        ]
    },
    {
        "name": "西瓜视频",
        "url": "https://www.ixigua.com/",
        "logo": "",
        "category": [
            "影视"
        ]
    },
    {
        "name": "咪咕视频",
        "url": "https://www.miguvideo.com/",
        "logo": "",
        "category": [
            "影视"
        ]
    },
    {
        "name": "虎牙影视",
        "url": "https://www.huya.com/",
        "logo": "",
        "category": [
            "直播"
        ]
    },
    {
        "name": "央视网",
        "url": "https://www.cctv.com/",
        "logo": "",
        "category": [
            "TV",
            "直播"
        ]
    },
    {
        "name": "CCTV 直播",
        "url": "https://tv.cctv.com/live/",
        "logo": "",
        "category": [
            "TV",
            "直播"
        ]
    },
    {
        "name": "PronHub",
        "url": "https://www.pornhub.com/",
        "logo": "",
        "category": [
            "HO"
        ]
    },
    {
        "name": "91Pron",
        "url": "https://www.91porn.com/index.php",
        "logo": "",
        "category": [
            "HO"
        ]
    },
    {
        "name": "Javtiful",
        "url": "https://javtiful.com/trending",
        "logo": "",
        "category": [
            "HO"
        ]
    },
    {
        "name": "Xvideo",
        "url": "https://de.xvideos.com/best",
        "logo": "",
        "category": [
            "HO"
        ]
    },
    {
        "name": "xHamster",
        "url": "https://ge.xhamster.desi/4k?formatFrozen=1",
        "logo": "",
        "category": [
            "HO"
        ]
    },
    {
        "name": "jable.tv",
        "url": "https://jable.tv/new-release/",
        "logo": "",
        "category": [
            "HO"
        ]
    },
    {
        "name": "thisav",
        "url": "https://thisav.me/zh-hant/",
        "logo": "",
        "category": [
            "HO"
        ]
    },
    {
        "name": "mm-cg.com",
        "url": "https://18av.mm-cg.com/zh/",
        "logo": "",
        "category": [
            "HO"
        ]
    },
    {
        "name": "Japan-whores",
        "url": "https://japan-whores.com/",
        "logo": "",
        "category": [
            "HO"
        ]
    },
    {
        "name": "HQPORNER",
        "url": "https://hqporner.com/category/4k-porn",
        "logo": "",
        "category": [
            "HO"
        ]
    },
    {
        "name": "Beeg",
        "url": "https://beeg.com/",
        "logo": "",
        "category": [
            "HO"
        ]
    },
    {
        "name": "EPORNER",
        "url": "https://www.eporner.com/best-videos/",
        "logo": "",
        "category": [
            "HO"
        ]
    },
    {
        "name": "XNXX",
        "url": "https://www.xnxx.com/",
        "logo": "",
        "category": [
            "HO"
        ]
    },
    {
        "name": "Javmost",
        "url": "https://www5.javmost.com/",
        "logo": "",
        "category": [
            "HO"
        ]
    },
    {
        "name": "Sehuatang",
        "url": "https://www.sehuatang.net/",
        "logo": "",
        "category": [
            "HO"
        ]
    },
    {
        "name": "IXXX",
        "url": "https://www.ixxx.com/popular",
        "logo": "",
        "category": [
            "HO"
        ]
    },
    {
        "name": "Netflav",
        "url": "https://netflav.com/",
        "logo": "",
        "category": [
            "HO"
        ]
    },
    {
        "name": "Forhertube",
        "url": "https://www.forhertube.com/c/korean",
        "logo": "",
        "category": [
            "HO"
        ]
    },
    {
        "name": "Avple",
        "url": "https://avple.tv/",
        "logo": "",
        "category": [
            "HO"
        ]
    },
    {
        "name": "Selfieav",
        "url": "https://selfieav.com/",
        "logo": "",
        "category": [
            "HO"
        ]
    },
    {
        "name": "Xchina",
        "url": "https://xchina.co/",
        "logo": "",
        "category": [
            "HO"
        ]
    },
    {
        "name": "animeidhentai",
        "url": "https://animeidhentai.com/home/",
        "logo": "",
        "category": [
            "HO"
        ]
    },
    {
        "name": "hanime1",
        "url": "https://hanime1.me/",
        "logo": "",
        "category": [
            "HO"
        ]
    },
    {
        "name": "Theporndude",
        "url": "https://theporndude.com/",
        "logo": "",
        "category": [
            "HO"
        ]
    }
];

window.currentCategory = 'all';

// 自动获取 favicon (使用 google s2)
function getFavicon(site) {
  try {
    if (site.logo && site.logo.length > 8) return site.logo;
    const url = new URL(site.url);
    return `https://www.google.com/s2/favicons?sz=64&domain=${url.hostname}`;
  } catch (e) {
    console.error("Error getting favicon:", e);
    return ''; // Return empty string on error
  }
}

function renderSites(category = 'all', query = '') {
  window.currentCategory = category;
  const container = document.getElementById('siteContainer');
  const resultCountEl = document.getElementById('resultCount');
  const buttons = document.querySelectorAll('#categoryButtons button');

  // 按钮高亮
  buttons.forEach(btn => {
    btn.classList.remove('ring', 'ring-blue-400', 'bg-blue-600', 'text-white');
    if (btn.textContent === category || (category === 'all' && btn.textContent === '全部')) {
      btn.classList.add('ring', 'ring-blue-400', 'bg-blue-600', 'text-white');
    }
  });

  // 筛选网站
  const filtered = sites.filter(site => {
    const matchCategory =
      category === 'all' ||
      (Array.isArray(site.category)
        ? site.category.includes(category)
        : site.category === category);
    const matchQuery = site.name.toLowerCase().includes((query || '').toLowerCase());
    return matchCategory && matchQuery;
  });

  // 更新数量
  resultCountEl.textContent = `共找到 ${filtered.length} 个网站`;
  container.innerHTML = '';

  for (const site of filtered) {
    // Exclude 'HO' category when 'all' is selected
    if (category === 'all' && Array.isArray(site.category) && site.category.includes('HO')) {
      continue;
    }

    const card = document.createElement('a');
    card.href = site.url;
    card.target = '_blank';
    card.rel = 'noopener';
    card.className = 'site-card flex flex-col gap-2 items-center bg-white dark:bg-[#20232a] border border-gray-200 dark:border-gray-800 rounded-2xl p-5 transition shadow-sm hover:shadow-lg';
    card.innerHTML = `
      <div class="w-16 h-16 flex items-center justify-center rounded-full bg-gray-100 dark:bg-gray-700 mb-2">
        <img src="${getFavicon(site)}" alt="${site.name}" class="max-w-[2.5rem] max-h-[2.5rem] object-contain" loading="lazy" onerror="this.onerror=null;this.src='data:image/svg+xml;utf8,<svg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 24 24\' fill=\'none\' stroke=\'currentColor\' stroke-width=\'2\' stroke-linecap=\'round\' stroke-linejoin=\'round\' class=\'feather feather-globe\'><circle cx=\'12\' cy=\'12\' r=\'10\'></circle><line x1=\'2\' y1=\'12\' x2=\'22\' y2=\'12\'></line><path d=\'M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z\'></path></svg>';">
      </div>
      <h2 class="text-center font-semibold text-base truncate w-full">${site.name}</h2>
      <p class="text-xs text-center text-gray-400 dark:text-gray-500 truncate w-full">${site.url.replace(/^https?:\/\//, '')}</p>
    `;
    container.appendChild(card);
  }
}

// 打开某分类所有网页
function openAllCategorySites(category) {
  let links = [];
  if (category === 'all') {
    links = sites.filter(site =>
      !(Array.isArray(site.category) && site.category.includes('HO'))
    );
  } else {
    links = sites.filter(site =>
      Array.isArray(site.category) ? site.category.includes(category) : site.category === category
    );
  }
  for (const site of links) {
    window.open(site.url, '_blank');
  }
}

// 点击分类按钮
function openCategorySites(category) {
  renderSites(category);
}

// 返回顶部按钮
const backToTopBtn = document.getElementById('backToTopBtn');
window.addEventListener('scroll', () => {
  backToTopBtn.style.display = window.pageYOffset > 300 ? 'block' : 'none';
});
backToTopBtn.addEventListener('click', () => {
  window.scrollTo({ top: 0, behavior: 'smooth' });
});

// 暗黑模式自动/切换
function updateDarkModeClass(isDark) {
  if (isDark) {
    document.documentElement.classList.add('dark');
    localStorage.setItem('theme', 'dark');
  } else {
    document.documentElement.classList.remove('dark');
    localStorage.setItem('theme', 'light');
  }
}

function detectSystemDark() {
  return window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
}

function setInitialTheme() {
  const saved = localStorage.getItem('theme');
  if (saved === 'dark') {
    updateDarkModeClass(true);
  } else if (saved === 'light') {
    updateDarkModeClass(false);
  } else {
    // If no theme saved, use system preference
    updateDarkModeClass(detectSystemDark());
  }
}

setInitialTheme();

// 监听系统暗黑模式变更
window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
  // Only update if user hasn't manually set a theme
  if (!localStorage.getItem('theme')) {
    updateDarkModeClass(e.matches);
  }
});

// 初次渲染默认显示全部分类
document.addEventListener('DOMContentLoaded', function() {
  renderSites('all');
});
