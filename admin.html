<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>App 管理后台</title>
<link rel="icon" href="https://wangwenzhi.eu.org/images/favicon_io/favicon-32x32.png">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
    body { font-family: 'SF Pro Display', -apple-system, sans-serif; margin: 0; background: #fafafa; color: #1d1d1f; }
    header { position: sticky; top: 0; background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); padding: 10px 20px;
             box-shadow: 0 2px 10px rgba(0,0,0,0.05); z-index: 10; display: flex; align-items: center; justify-content: space-between; }
    .logo { width: 30px; height: 30px; cursor: pointer; }
    .logo img { width: 100%; height: 100%; object-fit: contain; transition: transform 0.3s; }
    .logo:hover img { transform: scale(1.1); }
    h1 { font-size: 20px; font-weight: 600; margin: 0; flex: 1; text-align: center; }
    .back-home { background: none; border: none; font-size: 14px; color: #000; cursor: pointer; }
    #categories { max-width: 1000px; margin: 20px auto; padding: 0 20px; }
    .category { background: #fff; border-radius: 18px; padding: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin-bottom: 20px; }
    .category h2 { font-size: 18px; margin-bottom: 10px; display: flex; align-items: center; gap: 8px; }
    .category input[type="text"] { flex: 1; padding: 6px 8px; border-radius: 6px; border: 1px solid #ccc; font-size: 14px; }
    .app { display: grid; grid-template-columns: repeat(4, 1fr) auto; gap: 5px; margin-bottom: 5px; }
    .app input { padding: 6px 8px; border-radius: 6px; border: 1px solid #ccc; font-size: 12px; }
    button { cursor: pointer; border: none; border-radius: 8px; padding: 6px 10px; font-size: 12px; }
    .add-btn { background: #000; color: white; }
    .delete-btn { background: #dc3545; color: white; }
    .floating-btn {
    position: fixed;
    left: 30px;                  
    display: flex;
    align-items: center;
    gap: 10px;
    background-color: #000;      
    color: #fff;                 
    border: none;
    border-radius: 25px;         
    padding: 14px 22px;          
    font-size: 16px;
    cursor: pointer;
    box-shadow: 0 6px 15px rgba(0,0,0,0.3);
    transition: all 0.3s ease;
    z-index: 9999;
}

.floating-btn i {
    font-size: 18px;
}

/* 悬停效果 */
.floating-btn:hover {
    transform: translateY(-3px);
    background-color: #222;
    box-shadow: 0 8px 20px rgba(0,0,0,0.4);
}

/* 左下角按钮位置 */
#downloadBtn { bottom: 160px; }
#uploadBtn { bottom: 100px; }
#uploadImageBtn { bottom: 30px; }
    @media (prefers-color-scheme: dark) {
        body { background: #1c1c1e; color: #f5f5f7; }
        header { background: rgba(28, 28, 30, 0.9); box-shadow: 0 2px 10px rgba(0,0,0,0.3); }
        .category { background: #2c2c2e; box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
        .category input, .app input { background: #3a3a3c; color: #fff; border: 1px solid #555; }
        .back-home { color: #f5f5f7; }
        .floating-btn { background: #000; color: #fff; border: 1px solid #555; }
    }
</style>
</head>
<body>
<header>
    <a href="index.html" class="logo" title="返回首页">
        <img src="https://wangwenzhi.eu.org/images/favicon_io/apple-touch-icon.png" alt="Logo" loading="lazy">
    </a>
    <h1>App 管理后台</h1>
    <button class="back-home" onclick="window.location.href='index.html'">返回主页</button>
</header>
<div id="categories"></div>
<button id="uploadImageBtn" class="floating-btn" title="上传图片到 GitHub" onclick="window.open('https://github.com/wangwenzhiwwz/File/upload/master/images', '_blank')">
  <i class="fas fa-image"></i> 上传图片
</button>
<button id="downloadBtn" class="floating-btn" title="下载 apps.js">
  <i class="fas fa-download"></i> 下载数据
</button>
<button id="uploadBtn" class="floating-btn" title="上传到 GitHub">
  <i class="fas fa-upload"></i> 上传数据
</button>
<script src="apps.js"></script>
<script>
// apps.js 模板（请与 apps.js 文件内容保持同步，只用 %APPDATA_REPLACE% 作为 appData 部分占位符）
const appsJsTemplate = `
// 页面刷新函数
function refreshPage() {
    location.reload();
}

// 汉堡菜单切换功能
function setupHamburgerMenu() {
    const hamburger = document.querySelector('.hamburger');
    if (!hamburger) {
        console.warn('Hamburger menu element not found.');
        return;
    }
    hamburger.addEventListener('click', () => {
        const navLinks = document.querySelector('.nav-links');
        if (navLinks) {
            navLinks.classList.toggle('active');
        } else {
            console.warn('Navigation links element not found.');
        }
    });
}

// HTML 转义函数，防止 XSS
function escapeHtml(unsafe) {
    return unsafe
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
}

// 构造器函数，确保字段完整性并记录错误
function createApp({ name, description, link, icon }) {
    const errors = [];
    if (!name) errors.push('缺少 name 字段');
    if (!description) errors.push('缺少 description 字段');
    if (!link) errors.push('缺少 link 字段');
    if (!icon) errors.push('缺少 icon 字段');

    const app = {
        name: name || 'Unnamed App',
        description: description || 'No description available',
        link: link || '#',
        icon: icon || 'https://via.placeholder.com/60?text=No+Image'
    };

    if (errors.length > 0) {
        const errorMessage = \`应用 "\${app.name}" 数据错误: \${errors.join(', ')}\`;
        console.error(errorMessage);
        displayError(errorMessage);
    }

    return app;
}

// 显示错误信息的函数
function displayError(message) {
    let errorContainer = document.getElementById('error-container');
    if (!errorContainer) {
        errorContainer = document.createElement('div');
        errorContainer.id = 'error-container';
        Object.assign(errorContainer.style, {
            position: 'fixed',
            top: '10px',
            left: '50%',
            transform: 'translateX(-50%)',
            backgroundColor: '#ffebee',
            color: '#c62828',
            padding: '10px 20px',
            borderRadius: '5px',
            boxShadow: '0 2px 5px rgba(0,0,0,0.2)',
            zIndex: '1000',
            maxWidth: '80%',
            overflowY: 'auto',
            maxHeight: '200px'
        });
        document.body.appendChild(errorContainer);
    }

    const errorItem = document.createElement('p');
    errorItem.textContent = message;
    errorItem.style.margin = '5px 0';
    errorContainer.appendChild(errorItem);

    setTimeout(() => {
        errorItem.remove();
        if (!errorContainer.hasChildNodes()) {
            errorContainer.remove();
        }
    }, 10000);
}

// Optimized application data
const appData = %APPDATA_REPLACE%;

// 创建单个应用项的 HTML
function createAppItem(app) {
    return \`
        <div class="app-item">
            <a href="\${app.link}" class="app-link" target="_blank" rel="noopener noreferrer">
                <img class="app-icon" src="\${app.icon}" alt="\${escapeHtml(app.name)} Icon" loading="lazy" onerror="this.src='https://via.placeholder.com/60?text=Image+Not+Found'; console.warn('Failed to load image: \${app.icon}');">
                <h3 class="app-name">\${escapeHtml(app.name)}</h3>
                <p class="app-description">\${escapeHtml(app.description)}</p>
            </a>
        </div>
    \`;
}

// 创建应用类别的 HTML
function createCategory(category, index) {
    const appItems = category.apps.map(createAppItem).join('');
    return \`
        <section class="app-category" id="\${category.title.toLowerCase()}" style="animation-delay: \${index * 0.1}s;">
            <h2 class="app-category-title" data-index="\${index}" style="cursor: pointer;" title="点击打开所有该类网站">\${escapeHtml(category.title)}</h2>
            <div class="app-grid">\${appItems}</div>
        </section>
    \`;
}

// 全局事件处理函数
const scrollHandler = () => {
    const backToTop = document.getElementById('back-to-top');
    if (backToTop) {
        backToTop.classList.toggle('visible', window.scrollY > 300);
    }
};

const scrollToTop = () => {
    window.scrollTo({ top: 0, behavior: 'smooth' });
};

const smoothScroll = (e) => {
    e.preventDefault();
    const targetId = e.currentTarget.getAttribute('href').substring(1);
    const targetElement = document.getElementById(targetId);
    if (targetElement) {
        const headerOffset = 80; // 预留顶部空隙，避免标题被遮挡
        const elementPosition = targetElement.getBoundingClientRect().top + window.pageYOffset;
        const offsetPosition = elementPosition - headerOffset;
        window.scrollTo({
            top: offsetPosition,
            behavior: 'smooth'
        });
        document.querySelector('.nav-links')?.classList.remove('active');
    }
};

// 渲染所有类别并设置事件
function renderCategories() {
    const container = document.getElementById('app-container');
    if (!container) {
        console.error('App container element not found.');
        return;
    }
    if (!appData || !Array.isArray(appData)) {
        console.error('appData is not defined or not an array.');
        return;
    }

    const fragment = document.createDocumentFragment();
    appData.forEach((category, index) => {
        const div = document.createElement('div');
        div.innerHTML = createCategory(category, index);
        fragment.appendChild(div.firstElementChild);
    });
    container.appendChild(fragment);

    const backToTop = document.getElementById('back-to-top');
    if (backToTop) {
        window.removeEventListener('scroll', scrollHandler);
        window.addEventListener('scroll', scrollHandler);
        backToTop.removeEventListener('click', scrollToTop);
        backToTop.addEventListener('click', scrollToTop);
    }

    document.querySelectorAll('.nav-links a').forEach(anchor => {
        anchor.removeEventListener('click', smoothScroll);
        anchor.addEventListener('click', smoothScroll);
    });

    // 添加标题点击事件：打开所有链接
    document.querySelectorAll('.app-category-title').forEach(title => {
        title.addEventListener('click', () => {
            const index = title.getAttribute('data-index');
            const category = appData[parseInt(index)];
            if (category && category.apps) {
                category.apps.forEach(app => {
                    window.open(app.link, '_blank');
                });
            }
        });
    });
}

// 页面加载完成后初始化
document.addEventListener('DOMContentLoaded', () => {
    setupHamburgerMenu();
    renderCategories();
});
`;

(function(){
    const container = document.getElementById('categories');
    function render() {
        container.innerHTML = '';
        appData.forEach((cat, ci) => {
            const catDiv = document.createElement('div');
            catDiv.className = 'category';
            catDiv.innerHTML = `
                <h2>
                    <input type="text" value="${cat.title}" onchange="appData[${ci}].title=this.value">
                    <button class="delete-btn" onclick="deleteCategory(${ci})">删除分类</button>
                </h2>
                <div>
                    ${cat.apps.map((app, ai) => `
                        <div class="app">
                            <input value="${app.name}" placeholder="名称" onchange="appData[${ci}].apps[${ai}].name=this.value">
                            <input value="${app.description}" placeholder="描述" onchange="appData[${ci}].apps[${ai}].description=this.value">
                            <input value="${app.link}" placeholder="链接" onchange="appData[${ci}].apps[${ai}].link=this.value">
                            <input value="${app.icon}" placeholder="图标" onchange="appData[${ci}].apps[${ai}].icon=this.value">
                            <button class="delete-btn" onclick="deleteApp(${ci},${ai})">🗑</button>
                        </div>
                    `).join('')}
                </div>
                <button class="add-btn" onclick="addApp(${ci})">➕ 添加应用</button>
            `;
            container.appendChild(catDiv);
        });
    }
    window.addApp = function(ci) { appData[ci].apps.push({ name:"", description:"", link:"", icon:"" }); render(); }
    window.deleteApp = function(ci, ai) { if(confirm("确定删除这个应用吗？")){ appData[ci].apps.splice(ai,1); render(); } }
    window.deleteCategory = function(ci) { if(confirm("确定删除这个分类吗？")){ appData.splice(ci,1); render(); } }

    // 下载 apps.js 完整格式
    document.getElementById('downloadBtn').onclick = function(){
        // 替换 appData 部分，格式为缩进4空格
        const appDataStr = JSON.stringify(appData, null, 4);
        const fileContent = appsJsTemplate.replace('%APPDATA_REPLACE%', appDataStr);
        const blob = new Blob([fileContent], {type: "application/javascript"});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = "apps.js";
        a.click();
    }

    document.getElementById('uploadBtn').onclick = function(){
        window.location.href = "https://github.com/wangwenzhiwwz/File/upload/master";
    }
    render();
})();
</script>
</body>
</html>